<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Fund Planner</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,600;1,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
    :root {
        --bg-primary: #faf9f7;
        --bg-secondary: #f0eeea;
        --bg-card: #ffffff;
        --text-primary: #1a1a1a;
        --text-secondary: #5a5a5a;
        --text-muted: #8a8a8a;
        --accent: #2d5a4a;
        --accent-light: #e8f0ed;
        --border: #e0ddd8;
        --shadow: rgba(0, 0, 0, 0.06);
        --font-serif: 'Crimson Pro', Georgia, serif;
        --font-mono: 'JetBrains Mono', monospace;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: var(--font-serif);
        font-size: 18px;
        line-height: 1.7;
        color: var(--text-primary);
        background: var(--bg-primary);
        min-height: 100vh;
    }

    #access-gate {
        position: fixed;
        inset: 0;
        background: var(--bg-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .gate-content {
        text-align: center;
        padding: 2rem;
    }

    .gate-content h1 {
        font-size: 1.5rem;
        font-weight: 400;
        margin-bottom: 1rem;
        color: var(--text-secondary);
    }

    .gate-content p {
        color: var(--text-muted);
        font-size: 1rem;
    }

    #app {
        display: none;
        max-width: 1100px;
        margin: 0 auto;
        padding: 2rem 1.5rem 4rem;
    }

    #app.visible {
        display: block;
    }

    header {
        margin-bottom: 3rem;
        padding-bottom: 2rem;
        border-bottom: 1px solid var(--border);
    }

    header h1 {
        font-size: 2.2rem;
        font-weight: 600;
        letter-spacing: -0.02em;
        margin-bottom: 0.5rem;
    }

    header p {
        color: var(--text-secondary);
        font-size: 1.1rem;
    }

    section {
        margin-bottom: 3rem;
    }

    section h2 {
        font-size: 1.4rem;
        font-weight: 600;
        margin-bottom: 1.5rem;
        color: var(--accent);
    }

    .calculator-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 2rem;
        box-shadow: 0 2px 8px var(--shadow);
    }

    .input-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .input-group {
        display: flex;
        flex-direction: column;
    }

    .input-group label {
        font-size: 0.9rem;
        color: var(--text-secondary);
        margin-bottom: 0.5rem;
    }

    .input-group input {
        font-family: var(--font-mono);
        font-size: 1rem;
        padding: 0.75rem 1rem;
        border: 1px solid var(--border);
        border-radius: 4px;
        background: var(--bg-primary);
        transition: border-color 0.2s, box-shadow 0.2s;
    }

    .input-group input:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px var(--accent-light);
    }

    .input-group .hint {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-top: 0.3rem;
    }

    .toggle-group {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem 0;
        border-top: 1px solid var(--border);
        margin-top: 0.5rem;
    }

    .toggle-group label {
        font-size: 1rem;
        color: var(--text-primary);
        cursor: pointer;
    }

    .toggle-switch {
        position: relative;
        width: 52px;
        height: 28px;
        flex-shrink: 0;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .toggle-slider {
        position: absolute;
        cursor: pointer;
        inset: 0;
        background: var(--border);
        border-radius: 28px;
        transition: 0.3s;
    }

    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 22px;
        width: 22px;
        left: 3px;
        bottom: 3px;
        background: white;
        border-radius: 50%;
        transition: 0.3s;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    .toggle-switch input:checked + .toggle-slider {
        background: var(--accent);
    }

    .toggle-switch input:checked + .toggle-slider:before {
        transform: translateX(24px);
    }

    .btn {
        font-family: var(--font-serif);
        font-size: 1rem;
        padding: 0.875rem 2rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-primary {
        background: var(--accent);
        color: white;
    }

    .btn-primary:hover {
        background: #234a3c;
    }

    .btn-secondary {
        background: var(--bg-secondary);
        color: var(--text-primary);
        border: 1px solid var(--border);
    }

    .btn-secondary:hover {
        background: var(--border);
    }

    .button-row {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .results-summary {
        background: var(--accent-light);
        border-left: 4px solid var(--accent);
        padding: 1.5rem;
        margin: 2rem 0;
        border-radius: 0 4px 4px 0;
    }

    .results-summary h3 {
        font-size: 1rem;
        font-weight: 600;
        color: var(--accent);
        margin-bottom: 0.5rem;
    }

    .results-summary .amount {
        font-family: var(--font-mono);
        font-size: 2rem;
        font-weight: 500;
        color: var(--text-primary);
    }

    .results-summary .details {
        font-size: 0.95rem;
        color: var(--text-secondary);
        margin-top: 0.5rem;
    }

    .chart-container {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 1.5rem;
        margin: 2rem 0;
    }

    .chart-wrapper {
        position: relative;
        height: 400px;
    }

    .table-container {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 8px;
        overflow: hidden;
        margin: 2rem 0;
    }

    .table-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.5rem;
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border);
    }

    .table-header h3 {
        font-size: 1rem;
        font-weight: 600;
    }

    .table-scroll {
        max-height: 400px;
        overflow-y: auto;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
    }

    thead {
        position: sticky;
        top: 0;
        background: var(--bg-primary);
    }

    th, td {
        padding: 0.75rem 1rem;
        text-align: right;
        border-bottom: 1px solid var(--border);
    }

    th:first-child, td:first-child {
        text-align: left;
    }

    th {
        font-weight: 600;
        color: var(--text-secondary);
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    td {
        font-family: var(--font-mono);
        font-size: 0.85rem;
    }

    tr:hover td {
        background: var(--bg-secondary);
    }

    .positive {
        color: var(--accent);
    }

    .negative {
        color: #b54848;
    }

    .binding-row {
        background: #fff3e0;
    }

    .binding-row td {
        font-weight: 600;
    }

    .explanation {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 2rem;
    }

    .explanation h3 {
        font-size: 1.2rem;
        font-weight: 600;
        margin: 2rem 0 1rem;
        color: var(--text-primary);
    }

    .explanation h3:first-child {
        margin-top: 0;
    }

    .explanation p {
        margin-bottom: 1rem;
        color: var(--text-secondary);
    }

    .explanation .katex-display {
        margin: 1.5rem 0;
        overflow-x: auto;
    }

    .explanation ul {
        margin: 1rem 0 1rem 1.5rem;
        color: var(--text-secondary);
    }

    .explanation li {
        margin-bottom: 0.5rem;
    }

    .formula-box {
        background: var(--bg-secondary);
        border-radius: 6px;
        padding: 1.5rem;
        margin: 1.5rem 0;
        overflow-x: auto;
    }

    .example-table {
        width: 100%;
        margin: 1rem 0;
        font-size: 0.9rem;
    }

    .example-table th, .example-table td {
        padding: 0.5rem;
        border: 1px solid var(--border);
        text-align: center;
    }

    .example-table th {
        background: var(--bg-secondary);
    }

    .collapsible-trigger {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        user-select: none;
    }

    .collapsible-trigger::before {
        content: '▶';
        font-size: 0.7rem;
        transition: transform 0.2s;
    }

    .collapsible-trigger.open::before {
        transform: rotate(90deg);
    }

    .collapsible-content {
        display: none;
        padding-top: 1rem;
    }

    .collapsible-content.open {
        display: block;
    }

    @media (max-width: 600px) {
        body {
            font-size: 16px;
        }

        #app {
            padding: 1rem;
        }

        header h1 {
            font-size: 1.8rem;
        }

        .calculator-card {
            padding: 1.25rem;
        }

        .input-grid {
            grid-template-columns: 1fr;
        }

        .chart-wrapper {
            height: 300px;
        }

        .results-summary .amount {
            font-size: 1.5rem;
        }
    }
</style>

</head>
<body>
    <div id="access-gate">
        <div class="gate-content">
            <h1>This page is private</h1>
            <p>Access requires a valid link.</p>
        </div>
    </div>

<div id="app">
    <header>
        <h1>School Fund Planner</h1>
        <p>Calculate required savings for school fees, accounting for inflation and investment returns.</p>
    </header>

    <section id="calculator">
        <h2>Calculator</h2>
        <div class="calculator-card">
            <div class="input-grid">
                <div class="input-group">
                    <label for="annualFee">Annual Fee (£)</label>
                    <input type="text" id="annualFee" value="15,000" inputmode="numeric">
                    <span class="hint">Today's prices</span>
                </div>
                <div class="input-group">
                    <label for="startYears">Years until school starts</label>
                    <input type="text" id="startYears" value="5" placeholder="e.g. 5 or 5, 8">
                    <span class="hint">Comma-separated for multiple children</span>
                </div>
                <div class="input-group">
                    <label for="schoolYears">Years of schooling</label>
                    <input type="number" id="schoolYears" value="7" min="1" max="20">
                </div>
                <div class="input-group">
                    <label for="delayYears">Saving starts in (years)</label>
                    <input type="number" id="delayYears" value="0" min="0" max="20">
                    <span class="hint">0 = start now</span>
                </div>
                <div class="input-group">
                    <label for="inflation">Fee inflation (%)</label>
                    <input type="number" id="inflation" value="4" min="0" max="15" step="0.5">
                </div>
                <div class="input-group">
                    <label for="returnRate">Investment return (%)</label>
                    <input type="number" id="returnRate" value="5" min="0" max="20" step="0.5">
                </div>
            </div>
            
            <div class="toggle-group">
                <label class="toggle-switch">
                    <input type="checkbox" id="continueDuring">
                    <span class="toggle-slider"></span>
                </label>
                <label for="continueDuring">Continue contributions during school years</label>
            </div>

            <div class="button-row" style="margin-top: 1.5rem;">
                <button class="btn btn-primary" onclick="calculate()">Calculate</button>
                <button class="btn btn-secondary" onclick="downloadCSV()">Download CSV</button>
            </div>

            <div id="results" class="results-summary" style="display: none;">
                <h3>Required Annual Contribution</h3>
                <div class="amount" id="resultAmount">—</div>
                <div class="details" id="resultDetails"></div>
            </div>
        </div>
    </section>

    <section id="guide">
        <h2 class="collapsible-trigger open" onclick="toggleCollapsible(this)">Guide</h2>
        <div class="collapsible-content open">
            <div class="explanation">
                <h3>What This Tool Does</h3>
                <p>This calculator determines how much you need to save each year to cover future school fees. It accounts for fee inflation, investment returns, and ensures you'll always have sufficient funds when payments are due, even with multiple children starting at different times.</p>

                <h3>Input Parameters</h3>
                <ul>
                    <li><strong>Annual Fee</strong>: The current annual school fee in today's prices. This will be adjusted for inflation in future years.</li>
                    <li><strong>Years until school starts</strong>: How many years from now until each child begins school. Enter multiple values separated by commas for multiple children (e.g., "5, 8" for two children starting in 5 and 8 years).</li>
                    <li><strong>Years of schooling</strong>: The total duration of schooling per child (e.g., 7 years for secondary school, 13 for full private education).</li>
                    <li><strong>Saving starts in (years)</strong>: How many years from now before you begin saving. Use 0 to start immediately. This shifts the timeline so that "Year 1" in the calculations is when saving begins, with fees already inflated accordingly.</li>
                    <li><strong>Fee inflation</strong>: Expected annual increase in school fees. Historically, school fees have risen faster than general inflation (typically 3-5% per year).</li>
                    <li><strong>Investment return</strong>: Expected annual return on your savings. A balanced portfolio might return 4-6% on average over the long term.</li>
                    <li><strong>Continue contributions during school</strong>: If enabled, you continue making annual contributions while children are in school. If disabled, you only save before the first child starts, then draw down the fund.</li>
                </ul>

                <h3>Sensitivity Analysis</h3>
                <p>The chart below shows how the required annual contribution changes across different combinations of fee inflation and investment return rates. The x-axis varies inflation around your input value, while each coloured line represents a different return rate. This helps you understand how sensitive your savings plan is to these uncertain assumptions: if returns are lower or inflation higher than expected, you'll need to save more.</p>

                <h3>Cash Flow Schedule</h3>
                <p>The table provides a year-by-year breakdown showing your annual contribution, fee payments, investment returns, and running account balance. The row marked with an asterisk (*) is the <strong>binding constraint year</strong>, the point where your account balance is tightest (reaches zero). This is the year that determines your minimum required contribution.</p>

                <h3>Mathematical Explanation</h3>
                <p>The collapsible section at the bottom provides a rigorous derivation of the calculation methodology, including the balance evolution equations, geometric series simplifications, and the liquidity constraint that ensures your account never goes negative.</p>
            </div>
        </div>
    </section>

    <section id="chart-section">
        <h2>Sensitivity Analysis</h2>
        <div class="chart-container">
            <div class="chart-wrapper">
                <canvas id="sensitivityChart"></canvas>
            </div>
        </div>
    </section>

    <section id="cashflow-section">
        <h2>Cash Flow Schedule</h2>
        <div class="table-container">
            <div class="table-header">
                <h3>Year-by-Year Breakdown</h3>
            </div>
            <div class="table-scroll">
                <table id="cashflowTable">
                    <thead>
                        <tr>
                            <th>Year</th>
                            <th>Contribution</th>
                            <th>Fee Payment</th>
                            <th>Investment Return</th>
                            <th>End Balance</th>
                        </tr>
                    </thead>
                    <tbody id="cashflowBody">
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <section id="explanation-section">
        <h2 class="collapsible-trigger" onclick="toggleCollapsible(this)">Mathematical Explanation</h2>
        <div class="collapsible-content">
            <div class="explanation">
                <h3>1. Time Value of Money</h3>
                <p>Money has <strong>time value</strong>: £1 today is worth more than £1 tomorrow because you can invest it and earn a return. This means we cannot directly add or compare amounts at different points in time; we must first move them to a common reference point.</p>

                <p><strong>Compounding</strong> (moving forward in time): If you invest £\(P\) today at annual return \(r\), after one year you have:</p>
                <div class="formula-box">
                    $$P \times (1 + r)$$
                </div>
                <p>After \(t\) years, the balance grows to:</p>
                <div class="formula-box">
                    $$P \times (1 + r)^t$$
                </div>

                <p><strong>Discounting</strong> (moving backward in time): If you need £\(F\) in \(t\) years, the amount you must set aside today (the <strong>present value</strong>) is:</p>
                <div class="formula-box">
                    $$PV = \frac{F}{(1+r)^t} = F \times (1+r)^{-t}$$
                </div>

                <h3>2. Problem Setup and Notation</h3>
                <p>We have \(K\) children, where child \(k\) starts school in year \(Y_k\) (measured from today). Each child attends for \(n\) years. We also allow for a <strong>delay</strong> \(D \geq 0\) before saving begins. The core parameters are:</p>
                <ul>
                    <li>\(A\) = base annual fee (today's prices)</li>
                    <li>\(g\) = annual fee inflation rate</li>
                    <li>\(r\) = annual investment return rate</li>
                    <li>\(n\) = years of schooling per child</li>
                    <li>\(D\) = years before saving starts (0 = start now)</li>
                    <li>\(Y_k\) = year when child \(k\) starts school, measured from today</li>
                </ul>

                <p><strong>Timeline transformation:</strong> When \(D > 0\), we shift the timeline so that "Year 1" is when saving begins. This requires transforming the inputs:</p>
                <div class="formula-box">
                    $$A' = A \cdot (1+g)^D \quad \text{(fees have already inflated by } D \text{ years)}$$
                </div>
                <div class="formula-box">
                    $$Y'_k = Y_k - D \quad \text{(school is } D \text{ years closer from when saving starts)}$$
                </div>

                <p>All subsequent formulas use these transformed values \(A'\) and \(Y'_k\). For simplicity, we drop the primes and write \(A\) and \(Y_k\) with the understanding that they represent the values at the time saving begins. We then define:</p>
                <ul>
                    <li>\(Y_{\min} = \min_k Y_k\) = years until first child starts (from when saving begins)</li>
                    <li>\(Y_{\max} = \max_k Y_k\) = years until last child starts</li>
                    <li>\(T = Y_{\max} + n - 1\) = final year of the saving timeline</li>
                </ul>

                <h3>3. Fee Schedule for Multiple Children</h3>
                <p>School fees grow with inflation from year 1. In calendar year \(t\), the fee for one child in school is:</p>
                <div class="formula-box">
                    $$\text{Fee in year } t = A \cdot (1+g)^{t-1}$$
                </div>

                <p>Child \(k\) is in school during years \(Y_k, Y_k+1, \ldots, Y_k+n-1\). We define an indicator function:</p>
                <div class="formula-box">
                    $$\mathbf{1}_k(t) = \begin{cases} 1 & \text{if } Y_k \leq t \leq Y_k + n - 1 \\ 0 & \text{otherwise} \end{cases}$$
                </div>

                <p>The <strong>total fees in year \(t\)</strong> sum across all children in school that year:</p>
                <div class="formula-box">
                    $$F_t = A \cdot (1+g)^{t-1} \cdot \sum_{k=1}^{K} \mathbf{1}_k(t) = A \cdot (1+g)^{t-1} \cdot N_t \tag{1}$$
                </div>
                <p>where \(N_t = \sum_{k=1}^{K} \mathbf{1}_k(t)\) is the number of children in school during year \(t\).</p>

                <p><strong>Example:</strong> Two children with \(Y_1 = 2\) and \(Y_2 = 5\), each attending for \(n = 3\) years:</p>
                <table class="example-table">
                    <thead>
                        <tr><th>Year \(t\)</th><th>Child 1</th><th>Child 2</th><th>\(N_t\)</th><th>Fee \(F_t\)</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>1</td><td>—</td><td>—</td><td>0</td><td>0</td></tr>
                        <tr><td>2</td><td>Year 1</td><td>—</td><td>1</td><td>\(A(1+g)^1\)</td></tr>
                        <tr><td>3</td><td>Year 2</td><td>—</td><td>1</td><td>\(A(1+g)^2\)</td></tr>
                        <tr><td>4</td><td>Year 3</td><td>—</td><td>1</td><td>\(A(1+g)^3\)</td></tr>
                        <tr><td>5</td><td>—</td><td>Year 1</td><td>1</td><td>\(A(1+g)^4\)</td></tr>
                        <tr><td>6</td><td>—</td><td>Year 2</td><td>1</td><td>\(A(1+g)^5\)</td></tr>
                        <tr><td>7</td><td>—</td><td>Year 3</td><td>1</td><td>\(A(1+g)^6\)</td></tr>
                    </tbody>
                </table>

                <h3>4. Contribution Schedule</h3>
                <p>Let \(I_t \in \{0, 1\}\) indicate whether we contribute in year \(t\), and let \(C\) be the annual contribution amount (what we solve for).</p>

                <p><strong>Mode 1</strong> (save only before school starts):</p>
                <div class="formula-box">
                    $$I_t = \begin{cases} 1 & \text{if } t < Y_{\min} \\ 0 & \text{otherwise} \end{cases}$$
                </div>

                <p><strong>Mode 2</strong> (continue contributing during school):</p>
                <div class="formula-box">
                    $$I_t = 1 \quad \text{for all } t \in \{1, 2, \ldots, T\}$$
                </div>

                <h3>5. Balance Evolution</h3>
                <p>Let \(B_t\) denote the account balance at the end of year \(t\). The timing within each year is:</p>
                <ol>
                    <li>Start with balance \(B_{t-1}\) from previous year</li>
                    <li>Balance grows by investment return: \(B_{t-1} \times (1+r)\)</li>
                    <li>Add contribution \(I_t \cdot C\)</li>
                    <li>Pay fees \(F_t\)</li>
                </ol>

                <p>This gives the <strong>recurrence relation</strong>:</p>
                <div class="formula-box">
                    $$B_t = (1+r) \cdot B_{t-1} + I_t \cdot C - F_t, \quad \text{with } B_0 = 0 \tag{2}$$
                </div>

                <h3>6. Deriving the Closed-Form Solution</h3>
                <p>We solve the recurrence by expanding it step by step:</p>
                <div class="formula-box">
                    $$\begin{aligned}
                    B_1 &= (1+r) \cdot 0 + I_1 C - F_1 = I_1 C - F_1 \\[8pt]
                    B_2 &= (1+r) B_1 + I_2 C - F_2 \\
                        &= (1+r)(I_1 C - F_1) + I_2 C - F_2 \\
                        &= I_1 C (1+r) + I_2 C - F_1(1+r) - F_2 \\[8pt]
                    B_3 &= (1+r) B_2 + I_3 C - F_3 \\
                        &= I_1 C (1+r)^2 + I_2 C (1+r) + I_3 C - F_1(1+r)^2 - F_2(1+r) - F_3
                    \end{aligned}$$
                </div>

                <p>The pattern becomes clear. At year \(t\):</p>
                <div class="formula-box">
                    $$B_t = \sum_{s=1}^{t} I_s \cdot C \cdot (1+r)^{t-s} - \sum_{s=1}^{t} F_s \cdot (1+r)^{t-s}$$
                </div>

                <p>Factoring out \(C\):</p>
                <div class="formula-box">
                    $$B_t = C \cdot \underbrace{\sum_{s=1}^{t} I_s \cdot (1+r)^{t-s}}_{A_t} - \underbrace{\sum_{s=1}^{t} F_s \cdot (1+r)^{t-s}}_{V_t}$$
                </div>

                <p>We define the <strong>accumulated contribution factor</strong>:</p>
                <div class="formula-box">
                    $$A_t = \sum_{s=1}^{t} I_s \cdot (1+r)^{t-s} \tag{3}$$
                </div>
                <p>This is the future value at year \(t\) of £1 contributed in each contributing year.</p>

                <p>And the <strong>accumulated fee value</strong>:</p>
                <div class="formula-box">
                    $$V_t = \sum_{s=1}^{t} F_s \cdot (1+r)^{t-s} \tag{4}$$
                </div>
                <p>This is the future value at year \(t\) of all fees paid through year \(t\).</p>

                <p>Substituting (3) and (4) into our expanded recurrence gives the <strong>closed-form balance equation</strong>:</p>
                <div class="formula-box">
                    $$B_t = C \cdot A_t - V_t \tag{5}$$
                </div>

                <h3>7. Simplifying \(A_t\) Using Geometric Series</h3>
                <p>In <strong>Mode 2</strong> (contribute every year), \(I_s = 1\) for all \(s\), so:</p>
                <div class="formula-box">
                    $$A_t = \sum_{s=1}^{t} (1+r)^{t-s} = (1+r)^{t-1} + (1+r)^{t-2} + \cdots + (1+r)^0$$
                </div>

                <p>This is a geometric series with first term \(a = 1\), common ratio \(q = (1+r)\), and \(t\) terms. Recall the formula for the sum of a geometric series:</p>
                <div class="formula-box">
                    $$\sum_{i=0}^{n-1} q^i = \frac{q^n - 1}{q - 1} \tag{6}$$
                </div>

                <p>Applying (6) with \(q = 1+r\):</p>
                <div class="formula-box">
                    $$A_t = \frac{(1+r)^t - 1}{(1+r) - 1} = \frac{(1+r)^t - 1}{r} \tag{7}$$
                </div>

                <p>In <strong>Mode 1</strong> (contribute only for years \(1, \ldots, Y_{\min}-1\)), for \(t \geq Y_{\min}\):</p>
                <div class="formula-box">
                    $$A_t = \sum_{s=1}^{Y_{\min}-1} (1+r)^{t-s} = (1+r)^{t-1} + \cdots + (1+r)^{t-Y_{\min}+1}$$
                </div>

                <p>This is a geometric series with \(Y_{\min}-1\) terms, first term \((1+r)^{t-Y_{\min}+1}\), ratio \((1+r)\):</p>
                <div class="formula-box">
                    $$A_t = (1+r)^{t-Y_{\min}+1} \cdot \frac{(1+r)^{Y_{\min}-1} - 1}{r} = \frac{(1+r)^t - (1+r)^{t-Y_{\min}+1}}{r}$$
                </div>

                <h3>8. Simplifying \(V_t\) for Multiple Children</h3>
                <p>The accumulated fee value is:</p>
                <div class="formula-box">
                    $$V_t = \sum_{s=1}^{t} F_s \cdot (1+r)^{t-s}$$
                </div>

                <p>Substituting \(F_s = A(1+g)^{s-1} \cdot N_s\) where \(N_s\) is the number of children in school:</p>
                <div class="formula-box">
                    $$V_t = A \sum_{s=1}^{t} N_s \cdot (1+g)^{s-1} \cdot (1+r)^{t-s}$$
                </div>

                <p>For a <strong>single child</strong> starting in year \(Y\), we have \(N_s = 1\) for \(s \in \{Y, \ldots, Y+n-1\}\). The upper limit \(\min(t, Y+n-1)\) ensures we only sum over years when the child is actually in school:</p>
                <div class="formula-box">
                    $$V_t^{(\text{child})} = A \sum_{s=Y}^{\min(t, Y+n-1)} (1+g)^{s-1} (1+r)^{t-s}$$
                </div>

                <p>Let \(\rho = \frac{1+g}{1+r}\). Factoring out \((1+r)^t\) and rewriting:</p>
                <div class="formula-box">
                    $$V_t^{(\text{child})} = A (1+r)^t \sum_{s=Y}^{\min(t, Y+n-1)} \left(\frac{1+g}{1+r}\right)^{s-1} \cdot \frac{1}{1+g} = \frac{A (1+r)^t}{1+g} \sum_{s=Y}^{\min(t, Y+n-1)} \rho^{s-1}$$
                </div>

                <p>The inner sum is geometric. When summing from \(s = Y\) to \(s = m\) (where \(m = \min(t, Y+n-1)\)), we have \(m - Y + 1\) terms starting at \(\rho^{Y-1}\). Applying (6):</p>
                <div class="formula-box">
                    $$\sum_{s=Y}^{m} \rho^{s-1} = \rho^{Y-1} + \rho^Y + \cdots + \rho^{m-1} = \rho^{Y-1} \cdot \frac{1 - \rho^{m-Y+1}}{1 - \rho}$$
                </div>

                <p>For <strong>multiple children</strong>, the total accumulated fee value is:</p>
                <div class="formula-box">
                    $$V_t = \sum_{k=1}^{K} V_t^{(\text{child } k)}$$
                </div>

                <h3>9. The Liquidity Constraint</h3>
                <p>The fundamental requirement is that the account balance must never go negative:</p>
                <div class="formula-box">
                    $$B_t \geq 0 \quad \text{for all } t \in \{1, 2, \ldots, T\} \tag{8}$$
                </div>

                <p>Substituting the closed-form balance (5) into constraint (8):</p>
                <div class="formula-box">
                    $$C \cdot A_t - V_t \geq 0 \quad \Rightarrow \quad C \geq \frac{V_t}{A_t} \tag{9}$$
                </div>

                <p>Constraint (9) must hold for every year \(t\) where \(A_t > 0\). Therefore, the minimum contribution that satisfies all constraints is:</p>
                <div class="formula-box">
                    $$C_{\min} = \max_{t \in \{1, \ldots, T\}} \frac{V_t}{A_t} \tag{10}$$
                </div>

                <p>The year \(t^*\) where this maximum is achieved is the <strong>binding constraint year</strong>. At this year, substituting (10) into (5):</p>
                <div class="formula-box">
                    $$B_{t^*} = C_{\min} \cdot A_{t^*} - V_{t^*} = \frac{V_{t^*}}{A_{t^*}} \cdot A_{t^*} - V_{t^*} = 0 \tag{11}$$
                </div>

                <h3>10. Why the Naive Approach Can Fail</h3>
                <p>A naive present-value approach sets contributions equal to fees in present value terms, which is equivalent to enforcing only the terminal constraint \(B_T = 0\) from (8):</p>
                <div class="formula-box">
                    $$C_{\text{naive}} = \frac{V_T}{A_T} \tag{12}$$
                </div>

                <p>Comparing (12) with our solution (10), the naive approach fails when an intermediate year \(t < T\) has:</p>
                <div class="formula-box">
                    $$\frac{V_t}{A_t} > \frac{V_T}{A_T}$$
                </div>

                <p>In this case, using \(C_{\text{naive}}\) in equation (5) gives \(B_t = C_{\text{naive}} \cdot A_t - V_t < 0\), so the account goes negative, requiring borrowing.</p>

                <p><strong>When does this happen?</strong> From equations (3) and (4), the ratio \(V_t / A_t\) increases when fees are paid (adding to \(V_t\)) and decreases when contributions are made without corresponding fees (adding to \(A_t\)). An intermediate year becomes binding when:</p>
                <ul>
                    <li>Multiple children overlap, creating a "fee hump"</li>
                    <li>Contributions stop early (Mode 1) while fees continue</li>
                    <li>A gap between children allows the ratio to decrease before later fees</li>
                </ul>

                <h3>11. Worked Example</h3>
                <p>Consider:</p>
                <ul>
                    <li>Three children starting together: \(Y_1 = Y_2 = Y_3 = 2\)</li>
                    <li>One child starting later: \(Y_4 = 6\)</li>
                    <li>School duration: \(n = 3\) years each</li>
                    <li>Base fee: \(A = £10{,}000\)</li>
                    <li>Inflation: \(g = 0\%\) (to simplify)</li>
                    <li>Return: \(r = 5\%\)</li>
                    <li>Mode 2: contribute all years</li>
                </ul>

                <p><strong>Fee schedule:</strong></p>
                <table class="example-table">
                    <thead>
                        <tr><th>Year</th><th>Children in school</th><th>Fee \(F_t\)</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>1</td><td>0</td><td>£0</td></tr>
                        <tr><td>2</td><td>3 (children 1,2,3)</td><td>£30,000</td></tr>
                        <tr><td>3</td><td>3</td><td>£30,000</td></tr>
                        <tr><td>4</td><td>3</td><td>£30,000</td></tr>
                        <tr><td>5</td><td>0</td><td>£0</td></tr>
                        <tr><td>6</td><td>1 (child 4)</td><td>£10,000</td></tr>
                        <tr><td>7</td><td>1</td><td>£10,000</td></tr>
                        <tr><td>8</td><td>1</td><td>£10,000</td></tr>
                    </tbody>
                </table>

                <p><strong>Computing \(A_t\) and \(V_t\)</strong> using equations (3) and (4) with \(r = 0.05\):</p>
                <table class="example-table">
                    <thead>
                        <tr><th>Year \(t\)</th><th>\(A_t\)</th><th>\(V_t\)</th><th>\(V_t / A_t\)</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>1</td><td>1.000</td><td>0</td><td>0</td></tr>
                        <tr><td>2</td><td>2.050</td><td>30,000</td><td>14,634</td></tr>
                        <tr><td>3</td><td>3.153</td><td>61,500</td><td>19,513</td></tr>
                        <tr><td>4</td><td>4.310</td><td>94,575</td><td><strong>21,943</strong></td></tr>
                        <tr><td>5</td><td>5.526</td><td>99,304</td><td>17,974</td></tr>
                        <tr><td>6</td><td>6.802</td><td>114,269</td><td>16,799</td></tr>
                        <tr><td>7</td><td>8.142</td><td>129,982</td><td>15,965</td></tr>
                        <tr><td>8</td><td>9.549</td><td>146,481</td><td>15,340</td></tr>
                    </tbody>
                </table>

                <p>Applying equation (10), the maximum ratio occurs at <strong>year 4</strong> (value £21,943), not year 8. This is the binding constraint year \(t^* = 4\). Using the naive approach (12) would give \(C_{\text{naive}} = 15{,}340\), but substituting into (5) gives \(B_4 = 15{,}340 \times 4.310 - 94{,}575 = -28{,}470 < 0\), so the account goes negative.</p>

                <p>The correct minimum contribution from (10) is \(C_{\min} = £21{,}943\) per year, ensuring \(B_t \geq 0\) for all \(t\) as required by (8).</p>

                <h3>12. Key Insights</h3>
                <p>The ratio \(\rho = \frac{1+g}{1+r}\) (appearing in the fee calculations) determines the relationship between fee growth and investment returns:</p>
                <ul>
                    <li>If \(g < r\) (so \(\rho < 1\)): Investment returns outpace fee inflation, so the burden lightens over time</li>
                    <li>If \(g > r\) (so \(\rho > 1\)): Fees grow faster than investments, an uphill battle</li>
                    <li>If \(g = r\) (so \(\rho = 1\)): They balance out; each year's fee has the same present value</li>
                </ul>

                <p>In <strong>Mode 1</strong>, once contributions stop (\(I_t = 0\)), examining equations (3) and (4) shows that \(A_t\) only grows by compounding while \(V_t\) grows by compounding plus new fees. Thus \(V_t / A_t\) can only increase (when fees are paid) or stay constant (during gaps), so the binding constraint in (10) is always the terminal year. The naive approach (12) suffices.</p>

                <p>In <strong>Mode 2</strong>, ongoing contributions (\(I_t = 1\)) add to \(A_t\) each year, which can cause the ratio \(V_t / A_t\) to decrease during gap years or when fees drop. This is precisely when an intermediate year can become the binding constraint in (10), and the liquidity-aware calculation becomes essential.</p>
            </div>
        </div>
    </section>
</div>

<script>
    const VALID_HASH = 'finplanner';

    function checkAccess() {
        const hash = window.location.hash.substring(1);
        if (hash === VALID_HASH) {
            document.getElementById('access-gate').style.display = 'none';
            document.getElementById('app').classList.add('visible');
            return true;
        }
        return false;
    }

    /**
     * Build the fee schedule: F_t = total fees due in year t
     * Fees grow with inflation from year 0 (today).
     * Fee in year t = A * (1+g)^(t-1) for the first year of inflation indexing from year 1.
     */
    function buildFeeSchedule(A, g, n, startYears, totalYears) {
        const fees = new Array(totalYears + 1).fill(0); // fees[t] for t = 1 to totalYears

        startYears.forEach(startYear => {
            for (let schoolYear = 0; schoolYear < n; schoolYear++) {
                const calendarYear = startYear + schoolYear;
                if (calendarYear >= 1 && calendarYear <= totalYears) {
                    // Fee grows with inflation from year 1
                    const fee = A * Math.pow(1 + g, calendarYear - 1);
                    fees[calendarYear] += fee;
                }
            }
        });

        return fees;
    }

    /**
     * Build contribution indicator: I_t = 1 if contributing in year t, 0 otherwise
     * Mode 1 (continueDuring=false): contribute in years 1 to firstStart - 1
     * Mode 2 (continueDuring=true): contribute in years 1 to totalYears
     */
    function buildContributionIndicator(continueDuring, firstStart, totalYears) {
        const indicator = new Array(totalYears + 1).fill(0);
        const lastContribYear = continueDuring ? totalYears : firstStart - 1;

        for (let t = 1; t <= lastContribYear; t++) {
            indicator[t] = 1;
        }

        return indicator;
    }

    /**
     * Calculate the minimum contribution using liquidity constraints.
     *
     * Balance evolution: B_t = (1+r) * B_{t-1} + I_t * C - F_t
     *
     * Closed form: B_t = C * A_t - V_t
     * where:
     *   A_t = sum_{s=1}^{t} I_s * (1+r)^{t-s}  (accumulated contribution factor)
     *   V_t = sum_{s=1}^{t} F_s * (1+r)^{t-s}  (accumulated fee value)
     *
     * For B_t >= 0: C >= V_t / A_t
     *
     * C_min = max over all t of (V_t / A_t)
     */
    function calculateLiquidityConstrained(A, g, r, n, startYears, continueDuring) {
        const firstStart = Math.min(...startYears);
        const lastFeeYear = Math.max(...startYears) + n - 1;  // Last year of school
        const totalYears = lastFeeYear;

        const fees = buildFeeSchedule(A, g, n, startYears, totalYears);
        const indicator = buildContributionIndicator(continueDuring, firstStart, totalYears);

        let A_t = 0;  // Accumulated contribution factor
        let V_t = 0;  // Accumulated fee value
        let C_min = 0;
        let bindingYear = 1;

        for (let t = 1; t <= totalYears; t++) {
            // Update accumulated values: compound previous values and add current
            A_t = (1 + r) * A_t + indicator[t];
            V_t = (1 + r) * V_t + fees[t];

            // Calculate required contribution for this year's constraint
            if (A_t > 1e-10) {
                const ratio = V_t / A_t;
                if (ratio > C_min) {
                    C_min = ratio;
                    bindingYear = t;
                }
            }
        }

        // Also compute total PV for display purposes (using the standard formula)
        const pvTotal = computeTotalPV(A, g, r, n, startYears);

        // Count contribution years
        const contributionYears = continueDuring ? totalYears : Math.max(0, firstStart - 1);

        return {
            contribution: C_min,
            bindingYear,
            pvTotal,
            contributionYears,
            totalYears,
            fees,
            indicator
        };
    }

    /**
     * Compute total present value of fees (for display purposes)
     */
    function computeTotalPV(A, g, r, n, startYears) {
        const ratio = (1 + g) / (1 + r);

        let feeFactor;
        if (Math.abs(ratio - 1) < 1e-10) {
            feeFactor = n;
        } else {
            feeFactor = (1 - Math.pow(ratio, n)) / (1 - ratio);
        }

        return startYears.reduce((sum, startYear) => {
            const inflationDiscountFactor = Math.pow(ratio, startYear);
            return sum + A * inflationDiscountFactor * feeFactor;
        }, 0);
    }

    /**
     * Generate cash flows with correct timing:
     * At end of year t:
     *   1. Previous balance grows by (1+r)
     *   2. Add contribution if applicable
     *   3. Pay fees
     */
    function generateCashFlows(A, g, r, n, startYears, contribution, continueDuring) {
        const firstStart = Math.min(...startYears);
        const lastFeeYear = Math.max(...startYears) + n - 1;  // Last year of school
        const totalYears = lastFeeYear;

        const fees = buildFeeSchedule(A, g, n, startYears, totalYears);
        const indicator = buildContributionIndicator(continueDuring, firstStart, totalYears);

        const cashFlows = [];
        let balance = 0;

        for (let year = 1; year <= totalYears; year++) {
            const investmentReturn = balance * r;
            const yearContribution = indicator[year] * contribution;
            const feePayment = fees[year];

            balance = balance * (1 + r) + yearContribution - feePayment;

            cashFlows.push({
                year,
                contribution: yearContribution,
                feePayment,
                investmentReturn,
                endBalance: balance
            });
        }

        return cashFlows;
    }

    let chart = null;

    function parseNumber(str) {
        return parseFloat(str.replace(/[£,]/g, ''));
    }

    function formatCurrency(num) {
        return '£' + num.toLocaleString('en-GB', { 
            minimumFractionDigits: 0, 
            maximumFractionDigits: 0 
        });
    }

    function parseStartYears(str) {
        return str.split(',')
            .map(s => parseInt(s.trim()))
            .filter(n => !isNaN(n) && n >= 0);
    }

    function getInputs() {
        const A_original = parseNumber(document.getElementById('annualFee').value);
        const startYears_original = parseStartYears(document.getElementById('startYears').value);
        const n = parseInt(document.getElementById('schoolYears').value);
        const g = parseFloat(document.getElementById('inflation').value) / 100;
        const r = parseFloat(document.getElementById('returnRate').value) / 100;
        const D = parseInt(document.getElementById('delayYears').value) || 0;
        const continueDuring = document.getElementById('continueDuring').checked;

        if (isNaN(A_original) || startYears_original.length === 0 || isNaN(n) || isNaN(g) || isNaN(r)) {
            throw new Error('Please enter valid numbers');
        }

        const firstStart_original = Math.min(...startYears_original);
        if (D >= firstStart_original) {
            throw new Error('Saving must start before school begins (delay must be less than years until school starts)');
        }

        // Transform inputs: shift timeline so year 1 = when saving starts
        // A' = A × (1+g)^D (fee has already inflated by D years)
        // Y' = Y - D (school is D years closer from when we start saving)
        const A = A_original * Math.pow(1 + g, D);
        const startYears = startYears_original.map(y => y - D);

        const firstStart = Math.min(...startYears);
        const lastFeeYear = Math.max(...startYears) + n - 1;

        return { A, startYears, n, g, r, continueDuring, firstStart, lastFeeYear, D, A_original, startYears_original };
    }

    function calculate() {
        try {
            const { A, startYears, n, g, r, continueDuring, firstStart, lastFeeYear, D, A_original, startYears_original } = getInputs();

            const result = calculateLiquidityConstrained(A, g, r, n, startYears, continueDuring);
            const { contribution, bindingYear, pvTotal, contributionYears } = result;

            document.getElementById('results').style.display = 'block';
            document.getElementById('resultAmount').textContent = formatCurrency(contribution) + '/year';

            const childText = startYears_original.length === 1
                ? `1 child starting in ${startYears_original[0]} years`
                : `${startYears_original.length} children starting in years ${startYears_original.join(', ')}`;

            const delayText = D > 0 ? `Saving starts in ${D} years · ` : '';

            document.getElementById('resultDetails').innerHTML = `
                ${childText} · ${n} years of schooling<br>
                ${delayText}Contributing for ${contributionYears} years<br>
                Total fees present value: ${formatCurrency(pvTotal)}<br>
                <strong>Binding constraint: Year ${bindingYear}</strong> (of saving timeline)
            `;

            updateChart(A, startYears, n, continueDuring, g, r);

            const cashFlows = generateCashFlows(A, g, r, n, startYears, contribution, continueDuring);
            updateCashFlowTable(cashFlows, bindingYear);

        } catch (e) {
            alert(e.message);
        }
    }

    function updateChart(A, startYears, n, continueDuring, inputInflation, inputReturn) {
        // Center the sensitivity analysis around user's input values
        const inflationOffsets = [-0.03, -0.02, -0.01, 0, 0.01, 0.02, 0.03];
        const returnOffsets = [-0.02, -0.01, 0, 0.01, 0.02];

        const inflationRates = inflationOffsets
            .map(offset => Math.max(0, inputInflation + offset));  // Don't go below 0%
        const returnRates = returnOffsets
            .map(offset => Math.max(0.01, inputReturn + offset));  // Don't go below 1%

        const colors = [
            'rgb(180, 100, 80)',
            'rgb(200, 140, 110)',
            'rgb(45, 90, 74)',      // Input value (center) in accent color
            'rgb(70, 130, 110)',
            'rgb(100, 160, 140)'
        ];

        const datasets = returnRates.map((retRate, idx) => {
            const contributions = inflationRates.map(infRate => {
                const result = calculateLiquidityConstrained(A, infRate, retRate, n, startYears, continueDuring);
                return result.contribution;
            });

            const isInputReturn = Math.abs(retRate - inputReturn) < 0.001;
            return {
                label: `${(retRate * 100).toFixed(0)}% return${isInputReturn ? ' (selected)' : ''}`,
                data: contributions,
                borderColor: colors[idx],
                backgroundColor: colors[idx],
                tension: 0.3,
                pointRadius: isInputReturn ? 6 : 4,
                borderWidth: isInputReturn ? 3 : 2
            };
        });

        const ctx = document.getElementById('sensitivityChart').getContext('2d');

        if (chart) {
            chart.destroy();
        }

        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: inflationRates.map(infRate => {
                    const isInput = Math.abs(infRate - inputInflation) < 0.001;
                    return isInput ? `${(infRate * 100).toFixed(0)}%*` : `${(infRate * 100).toFixed(0)}%`;
                }),
                datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Required Annual Contribution vs. Inflation Rate',
                        font: { size: 14, family: "'Crimson Pro', serif" }
                    },
                    legend: {
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Fee Inflation Rate'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Annual Contribution (£)'
                        },
                        ticks: {
                            callback: function(value) {
                                return formatCurrency(value);
                            }
                        }
                    }
                }
            }
        });
    }

    function updateCashFlowTable(cashFlows, bindingYear) {
        const tbody = document.getElementById('cashflowBody');
        tbody.innerHTML = cashFlows.map(cf => {
            const isBinding = cf.year === bindingYear;
            const rowClass = isBinding ? 'binding-row' : '';
            const contribClass = cf.contribution > 0 ? 'positive' : '';
            const contribText = cf.contribution > 0 ? '+' + formatCurrency(cf.contribution) : '—';

            return `
                <tr class="${rowClass}">
                    <td>${cf.year}${isBinding ? ' *' : ''}</td>
                    <td class="${contribClass}">${contribText}</td>
                    <td class="${cf.feePayment > 0 ? 'negative' : ''}">${cf.feePayment > 0 ? '-' + formatCurrency(cf.feePayment) : '—'}</td>
                    <td class="${cf.investmentReturn >= 0 ? 'positive' : 'negative'}">${cf.investmentReturn >= 0 ? '+' : ''}${formatCurrency(cf.investmentReturn)}</td>
                    <td>${formatCurrency(Math.round(cf.endBalance))}</td>
                </tr>
            `;
        }).join('');
    }

    function downloadCSV() {
        try {
            const { A, startYears, n, g, r, continueDuring, D, A_original, startYears_original } = getInputs();
            const result = calculateLiquidityConstrained(A, g, r, n, startYears, continueDuring);
            const { contribution, bindingYear, pvTotal } = result;

            const cashFlows = generateCashFlows(A, g, r, n, startYears, contribution, continueDuring);

            const headers = ['Year', 'Contribution', 'Fee Payment', 'Investment Return', 'End Balance', 'Binding Year'];
            const rows = cashFlows.map(cf => [
                cf.year,
                cf.contribution.toFixed(2),
                cf.feePayment.toFixed(2),
                cf.investmentReturn.toFixed(2),
                cf.endBalance.toFixed(2),
                cf.year === bindingYear ? 'Yes' : ''
            ]);

            const summary = [
                ['School Fund Planner - Cash Flow Schedule'],
                [''],
                ['Parameters:'],
                ['Annual Fee (today)', A_original],
                ['Children start years (from today)', startYears_original.join('; ')],
                ['Years of schooling', n],
                ['Delay before saving (years)', D],
                ['Fee inflation rate', (g * 100).toFixed(1) + '%'],
                ['Investment return rate', (r * 100).toFixed(1) + '%'],
                ['Continue during school', continueDuring ? 'Yes' : 'No'],
                [''],
                ['Results:'],
                ['Required annual contribution', contribution.toFixed(2)],
                ['Total fees present value', pvTotal.toFixed(2)],
                ['Binding constraint year (of saving)', bindingYear],
                [''],
                headers,
                ...rows
            ];

            const csvContent = summary.map(row =>
                Array.isArray(row) ? row.join(',') : row
            ).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'school_fund_cashflows.csv';
            link.click();

        } catch (e) {
            alert(e.message);
        }
    }

    function toggleCollapsible(trigger) {
        trigger.classList.toggle('open');
        const content = trigger.nextElementSibling;
        content.classList.toggle('open');
    }

    document.addEventListener('DOMContentLoaded', function() {
        if (checkAccess()) {
            renderMathInElement(document.body, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '\\(', right: '\\)', display: false},
                    {left: '\\[', right: '\\]', display: true}
                ],
                throwOnError: false
            });

            calculate();
        }
    });

    window.addEventListener('hashchange', function() {
        if (checkAccess()) {
            location.reload();
        }
    });
</script>

</body>
</html>
