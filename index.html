<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Fund Planner</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,600;1,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
    :root {
        --bg-primary: #faf9f7;
        --bg-secondary: #f0eeea;
        --bg-card: #ffffff;
        --text-primary: #1a1a1a;
        --text-secondary: #5a5a5a;
        --text-muted: #8a8a8a;
        --accent: #2d5a4a;
        --accent-light: #e8f0ed;
        --border: #e0ddd8;
        --shadow: rgba(0, 0, 0, 0.06);
        --font-serif: 'Crimson Pro', Georgia, serif;
        --font-mono: 'JetBrains Mono', monospace;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: var(--font-serif);
        font-size: 18px;
        line-height: 1.7;
        color: var(--text-primary);
        background: var(--bg-primary);
        min-height: 100vh;
    }

    #access-gate {
        position: fixed;
        inset: 0;
        background: var(--bg-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .gate-content {
        text-align: center;
        padding: 2rem;
    }

    .gate-content h1 {
        font-size: 1.5rem;
        font-weight: 400;
        margin-bottom: 1rem;
        color: var(--text-secondary);
    }

    .gate-content p {
        color: var(--text-muted);
        font-size: 1rem;
    }

    #app {
        display: none;
        max-width: 1100px;
        margin: 0 auto;
        padding: 2rem 1.5rem 4rem;
    }

    #app.visible {
        display: block;
    }

    header {
        margin-bottom: 3rem;
        padding-bottom: 2rem;
        border-bottom: 1px solid var(--border);
    }

    header h1 {
        font-size: 2.2rem;
        font-weight: 600;
        letter-spacing: -0.02em;
        margin-bottom: 0.5rem;
    }

    header p {
        color: var(--text-secondary);
        font-size: 1.1rem;
    }

    section {
        margin-bottom: 3rem;
    }

    section h2 {
        font-size: 1.4rem;
        font-weight: 600;
        margin-bottom: 1.5rem;
        color: var(--accent);
    }

    .calculator-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 2rem;
        box-shadow: 0 2px 8px var(--shadow);
    }

    .input-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .input-group {
        display: flex;
        flex-direction: column;
    }

    .input-group label {
        font-size: 0.9rem;
        color: var(--text-secondary);
        margin-bottom: 0.5rem;
    }

    .input-group input {
        font-family: var(--font-mono);
        font-size: 1rem;
        padding: 0.75rem 1rem;
        border: 1px solid var(--border);
        border-radius: 4px;
        background: var(--bg-primary);
        transition: border-color 0.2s, box-shadow 0.2s;
    }

    .input-group input:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px var(--accent-light);
    }

    .input-group .hint {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-top: 0.3rem;
    }

    .toggle-group {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem 0;
        border-top: 1px solid var(--border);
        margin-top: 0.5rem;
    }

    .toggle-group label {
        font-size: 1rem;
        color: var(--text-primary);
        cursor: pointer;
    }

    .toggle-switch {
        position: relative;
        width: 52px;
        height: 28px;
        flex-shrink: 0;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .toggle-slider {
        position: absolute;
        cursor: pointer;
        inset: 0;
        background: var(--border);
        border-radius: 28px;
        transition: 0.3s;
    }

    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 22px;
        width: 22px;
        left: 3px;
        bottom: 3px;
        background: white;
        border-radius: 50%;
        transition: 0.3s;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    .toggle-switch input:checked + .toggle-slider {
        background: var(--accent);
    }

    .toggle-switch input:checked + .toggle-slider:before {
        transform: translateX(24px);
    }

    .btn {
        font-family: var(--font-serif);
        font-size: 1rem;
        padding: 0.875rem 2rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-primary {
        background: var(--accent);
        color: white;
    }

    .btn-primary:hover {
        background: #234a3c;
    }

    .btn-secondary {
        background: var(--bg-secondary);
        color: var(--text-primary);
        border: 1px solid var(--border);
    }

    .btn-secondary:hover {
        background: var(--border);
    }

    .button-row {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .results-summary {
        background: var(--accent-light);
        border-left: 4px solid var(--accent);
        padding: 1.5rem;
        margin: 2rem 0;
        border-radius: 0 4px 4px 0;
    }

    .results-summary h3 {
        font-size: 1rem;
        font-weight: 600;
        color: var(--accent);
        margin-bottom: 0.5rem;
    }

    .results-summary .amount {
        font-family: var(--font-mono);
        font-size: 2rem;
        font-weight: 500;
        color: var(--text-primary);
    }

    .results-summary .details {
        font-size: 0.95rem;
        color: var(--text-secondary);
        margin-top: 0.5rem;
    }

    .chart-container {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 1.5rem;
        margin: 2rem 0;
    }

    .chart-wrapper {
        position: relative;
        height: 400px;
    }

    .table-container {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 8px;
        overflow: hidden;
        margin: 2rem 0;
    }

    .table-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.5rem;
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border);
    }

    .table-header h3 {
        font-size: 1rem;
        font-weight: 600;
    }

    .table-scroll {
        max-height: 400px;
        overflow-y: auto;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
    }

    thead {
        position: sticky;
        top: 0;
        background: var(--bg-primary);
    }

    th, td {
        padding: 0.75rem 1rem;
        text-align: right;
        border-bottom: 1px solid var(--border);
    }

    th:first-child, td:first-child {
        text-align: left;
    }

    th {
        font-weight: 600;
        color: var(--text-secondary);
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    td {
        font-family: var(--font-mono);
        font-size: 0.85rem;
    }

    tr:hover td {
        background: var(--bg-secondary);
    }

    .positive {
        color: var(--accent);
    }

    .negative {
        color: #b54848;
    }

    .binding-row {
        background: #fff3e0;
    }

    .binding-row td {
        font-weight: 600;
    }

    .explanation {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 2rem;
    }

    .explanation h3 {
        font-size: 1.2rem;
        font-weight: 600;
        margin: 2rem 0 1rem;
        color: var(--text-primary);
    }

    .explanation h3:first-child {
        margin-top: 0;
    }

    .explanation p {
        margin-bottom: 1rem;
        color: var(--text-secondary);
    }

    .explanation .katex-display {
        margin: 1.5rem 0;
        overflow-x: auto;
    }

    .explanation ul {
        margin: 1rem 0 1rem 1.5rem;
        color: var(--text-secondary);
    }

    .explanation li {
        margin-bottom: 0.5rem;
    }

    .formula-box {
        background: var(--bg-secondary);
        border-radius: 6px;
        padding: 1.5rem;
        margin: 1.5rem 0;
        overflow-x: auto;
    }

    .example-table {
        width: 100%;
        margin: 1rem 0;
        font-size: 0.9rem;
    }

    .example-table th, .example-table td {
        padding: 0.5rem;
        border: 1px solid var(--border);
        text-align: center;
    }

    .example-table th {
        background: var(--bg-secondary);
    }

    .collapsible-trigger {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        user-select: none;
    }

    .collapsible-trigger::before {
        content: '▶';
        font-size: 0.7rem;
        transition: transform 0.2s;
    }

    .collapsible-trigger.open::before {
        transform: rotate(90deg);
    }

    .collapsible-content {
        display: none;
        padding-top: 1rem;
    }

    .collapsible-content.open {
        display: block;
    }

    @media (max-width: 600px) {
        body {
            font-size: 16px;
        }

        #app {
            padding: 1rem;
        }

        header h1 {
            font-size: 1.8rem;
        }

        .calculator-card {
            padding: 1.25rem;
        }

        .input-grid {
            grid-template-columns: 1fr;
        }

        .chart-wrapper {
            height: 300px;
        }

        .results-summary .amount {
            font-size: 1.5rem;
        }
    }
</style>

</head>
<body>
    <div id="access-gate">
        <div class="gate-content">
            <h1>This page is private</h1>
            <p>Access requires a valid link.</p>
        </div>
    </div>

<div id="app">
    <header>
        <h1>School Fund Planner</h1>
        <p>Calculate required savings for school fees, accounting for inflation and investment returns.</p>
    </header>

    <section id="introduction">
        <div class="explanation">
            <h3>What This Tool Does</h3>
            <p>This calculator helps you determine how much you need to save each year to cover future school fees. It accounts for fee inflation, investment returns, and ensures you'll always have sufficient funds when payments are due—even with multiple children starting at different times.</p>

            <h3>Input Parameters</h3>
            <ul>
                <li><strong>Annual Fee</strong> — The current annual school fee in today's prices. This will be adjusted for inflation in future years.</li>
                <li><strong>Years until school starts</strong> — How many years from now until each child begins school. Enter multiple values separated by commas for multiple children (e.g., "5, 8" for two children starting in 5 and 8 years).</li>
                <li><strong>Years of schooling</strong> — The total duration of schooling per child (e.g., 7 years for secondary school, 13 for full private education).</li>
                <li><strong>Fee inflation</strong> — Expected annual increase in school fees. Historically, school fees have risen faster than general inflation (typically 3–5% per year).</li>
                <li><strong>Investment return</strong> — Expected annual return on your savings. A balanced portfolio might return 4–6% on average over the long term.</li>
                <li><strong>Continue contributions during school</strong> — If enabled, you continue making annual contributions while children are in school. If disabled, you only save before the first child starts, then draw down the fund.</li>
            </ul>
        </div>
    </section>

    <section id="calculator">
        <h2>Calculator</h2>
        <div class="calculator-card">
            <div class="input-grid">
                <div class="input-group">
                    <label for="annualFee">Annual Fee (£)</label>
                    <input type="text" id="annualFee" value="15,000" inputmode="numeric">
                    <span class="hint">Today's prices</span>
                </div>
                <div class="input-group">
                    <label for="startYears">Years until school starts</label>
                    <input type="text" id="startYears" value="5" placeholder="e.g. 5 or 5, 8">
                    <span class="hint">Comma-separated for multiple children</span>
                </div>
                <div class="input-group">
                    <label for="schoolYears">Years of schooling</label>
                    <input type="number" id="schoolYears" value="7" min="1" max="20">
                </div>
                <div class="input-group">
                    <label for="inflation">Fee inflation (%)</label>
                    <input type="number" id="inflation" value="4" min="0" max="15" step="0.5">
                </div>
                <div class="input-group">
                    <label for="returnRate">Investment return (%)</label>
                    <input type="number" id="returnRate" value="5" min="0" max="20" step="0.5">
                </div>
            </div>
            
            <div class="toggle-group">
                <label class="toggle-switch">
                    <input type="checkbox" id="continueDuring">
                    <span class="toggle-slider"></span>
                </label>
                <label for="continueDuring">Continue contributions during school years</label>
            </div>

            <div class="button-row" style="margin-top: 1.5rem;">
                <button class="btn btn-primary" onclick="calculate()">Calculate</button>
                <button class="btn btn-secondary" onclick="downloadCSV()">Download CSV</button>
            </div>

            <div id="results" class="results-summary" style="display: none;">
                <h3>Required Annual Contribution</h3>
                <div class="amount" id="resultAmount">—</div>
                <div class="details" id="resultDetails"></div>
            </div>
        </div>
    </section>

    <section id="chart-section">
        <h2>Sensitivity Analysis</h2>
        <div class="chart-container">
            <div class="chart-wrapper">
                <canvas id="sensitivityChart"></canvas>
            </div>
        </div>
    </section>

    <section id="cashflow-section">
        <h2>Cash Flow Schedule</h2>
        <div class="table-container">
            <div class="table-header">
                <h3>Year-by-Year Breakdown</h3>
            </div>
            <div class="table-scroll">
                <table id="cashflowTable">
                    <thead>
                        <tr>
                            <th>Year</th>
                            <th>Contribution</th>
                            <th>Fee Payment</th>
                            <th>Investment Return</th>
                            <th>End Balance</th>
                        </tr>
                    </thead>
                    <tbody id="cashflowBody">
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <section id="explanation-section">
        <h2 class="collapsible-trigger" onclick="toggleCollapsible(this)">Mathematical Explanation</h2>
        <div class="collapsible-content">
            <div class="explanation">
                <h3>The Core Idea</h3>
                <p>Money has <strong>time value</strong>: £1 today is worth more than £1 tomorrow because you can invest it and earn a return. This means we can't directly add or compare amounts at different points in time—we need to move them to the same point first.</p>

                <p><strong>Compounding</strong> (moving forward in time): If you have £100 today and earn 5% per year, in one year you have:</p>
                <div class="formula-box">
                    $$100 \times (1 + 0.05) = £105$$
                </div>
                <p>In two years:</p>
                <div class="formula-box">
                    $$100 \times (1.05)^2 = £110.25$$
                </div>

                <p><strong>Discounting</strong> (moving backward in time): If you need £100 in one year, how much must you set aside today at 5%?</p>
                <div class="formula-box">
                    $$\frac{100}{1.05} = £95.24$$
                </div>
                <p>This is the <strong>present value</strong> of that future £100.</p>

                <h3>The Liquidity Constraint Problem</h3>
                <p>A naive approach calculates the present value of all fees and finds a contribution that matches it. However, this only ensures you end up with £0 at the final year—<strong>it doesn't guarantee you have enough money at every point in time</strong>.</p>

                <p>With multiple children starting at different times, fee payments can create "withdrawal humps" that exceed what the accumulated savings can cover, causing the account to go negative. This calculator uses a <strong>liquidity-constrained</strong> approach that ensures the account balance never goes negative.</p>

                <h3>Mathematical Framework</h3>
                <p>Let's define the key variables:</p>
                <ul>
                    <li>\(T\) = final year (when last child finishes school)</li>
                    <li>\(r\) = annual investment return rate</li>
                    <li>\(g\) = annual fee inflation rate</li>
                    <li>\(F_t\) = total fees due in year \(t\)</li>
                    <li>\(I_t\) = contribution indicator (1 if contributing in year \(t\), 0 otherwise)</li>
                    <li>\(C\) = annual contribution (what we're solving for)</li>
                    <li>\(B_t\) = account balance at end of year \(t\)</li>
                </ul>

                <h3>Balance Evolution</h3>
                <p>At the end of each year \(t\):</p>
                <ol>
                    <li>Previous balance \(B_{t-1}\) grows by factor \((1+r)\)</li>
                    <li>Add contribution \(C\) if \(I_t = 1\)</li>
                    <li>Pay fees \(F_t\)</li>
                </ol>

                <p>This gives the recurrence:</p>
                <div class="formula-box">
                    $$B_t = (1+r) \cdot B_{t-1} + I_t \cdot C - F_t$$
                </div>
                <p>with \(B_0 = 0\).</p>

                <h3>Closed-Form Solution</h3>
                <p>Unwinding the recurrence:</p>
                <div class="formula-box">
                    $$B_t = C \cdot \sum_{s=1}^{t} I_s \cdot (1+r)^{t-s} - \sum_{s=1}^{t} F_s \cdot (1+r)^{t-s}$$
                </div>

                <p>Define two key quantities:</p>

                <p><strong>Accumulated Contribution Factor:</strong></p>
                <div class="formula-box">
                    $$A_t = \sum_{s=1}^{t} I_s \cdot (1+r)^{t-s}$$
                </div>
                <p>This is the future value at year \(t\) of £1 contributed in each contributing year up to \(t\).</p>

                <p><strong>Accumulated Fee Value:</strong></p>
                <div class="formula-box">
                    $$V_t = \sum_{s=1}^{t} F_s \cdot (1+r)^{t-s}$$
                </div>
                <p>This is the future value at year \(t\) of all fees paid through year \(t\).</p>

                <p>So we have:</p>
                <div class="formula-box">
                    $$B_t = C \cdot A_t - V_t$$
                </div>

                <h3>The Liquidity Constraint</h3>
                <p>For the account to remain solvent, we need \(B_t \geq 0\) for all \(t\). This requires:</p>
                <div class="formula-box">
                    $$C \cdot A_t \geq V_t \quad \Rightarrow \quad C \geq \frac{V_t}{A_t}$$
                </div>
                <p>for all years \(t\) where \(A_t > 0\).</p>

                <h3>The Solution</h3>
                <p>The minimum contribution satisfying all liquidity constraints is:</p>
                <div class="formula-box">
                    $$\boxed{C_{\min} = \max_{t \in \{1, \ldots, T\}} \left( \frac{V_t}{A_t} \right)}$$
                </div>

                <p>The year \(t^*\) where this maximum occurs is the <strong>binding constraint year</strong>—the point where the account balance is exactly zero and under maximum stress. In the cash flow table, this year is highlighted.</p>

                <h3>Why This Matters</h3>
                <p>A naive present-value approach would compute:</p>
                <div class="formula-box">
                    $$C_{\text{naive}} = \frac{V_T}{A_T}$$
                </div>
                <p>This only enforces \(B_T = 0\) at the final year. But with multiple children at different start times, an intermediate year might have:</p>
                <div class="formula-box">
                    $$\frac{V_t}{A_t} > \frac{V_T}{A_T}$$
                </div>
                <p>In this case, the naive contribution would cause a negative balance at year \(t\), requiring you to borrow money—which breaks the model.</p>

                <h3>Fee Schedule</h3>
                <p>Fees grow with inflation from year 1. For a child starting in year \(Y\) with \(n\) years of schooling and base annual fee \(A\):</p>
                <div class="formula-box">
                    $$F_t^{(\text{child})} = \begin{cases} A \cdot (1+g)^{t-1} & \text{if } Y \leq t < Y + n \\ 0 & \text{otherwise} \end{cases}$$
                </div>
                <p>Total fees in year \(t\) sum across all children in school that year.</p>

                <h3>Contribution Modes</h3>
                <ul>
                    <li><strong>Mode 1</strong> (stop when school starts): \(I_t = 1\) for \(t < Y_{\min}\), else 0</li>
                    <li><strong>Mode 2</strong> (continue during school): \(I_t = 1\) for all \(t \leq T\)</li>
                </ul>

                <h3>Worked Example</h3>
                <p>Consider two children:</p>
                <ul>
                    <li>Child 1: starts year 2, 3 years of school</li>
                    <li>Child 2: starts year 6, 3 years of school</li>
                    <li>Base fee: £10,000/year, inflation \(g = 3\%\)</li>
                    <li>Investment return \(r = 5\%\)</li>
                    <li>Mode 2: contribute through all years</li>
                </ul>

                <p>The algorithm computes \(V_t / A_t\) for each year and finds the maximum. If Child 1's fees create a large early withdrawal before later contributions accumulate, an intermediate year becomes the binding constraint—requiring a higher contribution than the naive formula would suggest.</p>

                <h3>Key Insight</h3>
                <p>The ratio \(\rho = \frac{1+g}{1+r}\) determines how fees grow relative to your investment returns:</p>
                <ul>
                    <li>If \(g < r\) (so \(\rho < 1\)): Fees grow slower than investments—saving gets easier over time</li>
                    <li>If \(g > r\) (so \(\rho > 1\)): Fees outpace investments—you're fighting an uphill battle</li>
                    <li>If \(g = r\) (so \(\rho = 1\)): They balance out, and each year's fee has the same present value</li>
                </ul>
            </div>
        </div>
    </section>
</div>

<script>
    const VALID_HASH = 'finplanner';

    function checkAccess() {
        const hash = window.location.hash.substring(1);
        if (hash === VALID_HASH) {
            document.getElementById('access-gate').style.display = 'none';
            document.getElementById('app').classList.add('visible');
            return true;
        }
        return false;
    }

    /**
     * Build the fee schedule: F_t = total fees due in year t
     * Fees grow with inflation from year 0 (today).
     * Fee in year t = A * (1+g)^(t-1) for the first year of inflation indexing from year 1.
     */
    function buildFeeSchedule(A, g, n, startYears, totalYears) {
        const fees = new Array(totalYears + 1).fill(0); // fees[t] for t = 1 to totalYears

        startYears.forEach(startYear => {
            for (let schoolYear = 0; schoolYear < n; schoolYear++) {
                const calendarYear = startYear + schoolYear;
                if (calendarYear >= 1 && calendarYear <= totalYears) {
                    // Fee grows with inflation from year 1
                    const fee = A * Math.pow(1 + g, calendarYear - 1);
                    fees[calendarYear] += fee;
                }
            }
        });

        return fees;
    }

    /**
     * Build contribution indicator: I_t = 1 if contributing in year t, 0 otherwise
     * Mode 1 (continueDuring=false): contribute in years 1 to firstStart - 1
     * Mode 2 (continueDuring=true): contribute in years 1 to totalYears
     */
    function buildContributionIndicator(continueDuring, firstStart, totalYears) {
        const indicator = new Array(totalYears + 1).fill(0);
        const lastContribYear = continueDuring ? totalYears : firstStart - 1;

        for (let t = 1; t <= lastContribYear; t++) {
            indicator[t] = 1;
        }

        return indicator;
    }

    /**
     * Calculate the minimum contribution using liquidity constraints.
     *
     * Balance evolution: B_t = (1+r) * B_{t-1} + I_t * C - F_t
     *
     * Closed form: B_t = C * A_t - V_t
     * where:
     *   A_t = sum_{s=1}^{t} I_s * (1+r)^{t-s}  (accumulated contribution factor)
     *   V_t = sum_{s=1}^{t} F_s * (1+r)^{t-s}  (accumulated fee value)
     *
     * For B_t >= 0: C >= V_t / A_t
     *
     * C_min = max over all t of (V_t / A_t)
     */
    function calculateLiquidityConstrained(A, g, r, n, startYears, continueDuring) {
        const firstStart = Math.min(...startYears);
        const lastFeeYear = Math.max(...startYears) + n - 1;  // Last year of school
        const totalYears = lastFeeYear;

        const fees = buildFeeSchedule(A, g, n, startYears, totalYears);
        const indicator = buildContributionIndicator(continueDuring, firstStart, totalYears);

        let A_t = 0;  // Accumulated contribution factor
        let V_t = 0;  // Accumulated fee value
        let C_min = 0;
        let bindingYear = 1;

        for (let t = 1; t <= totalYears; t++) {
            // Update accumulated values: compound previous values and add current
            A_t = (1 + r) * A_t + indicator[t];
            V_t = (1 + r) * V_t + fees[t];

            // Calculate required contribution for this year's constraint
            if (A_t > 1e-10) {
                const ratio = V_t / A_t;
                if (ratio > C_min) {
                    C_min = ratio;
                    bindingYear = t;
                }
            }
        }

        // Also compute total PV for display purposes (using the standard formula)
        const pvTotal = computeTotalPV(A, g, r, n, startYears);

        // Count contribution years
        const contributionYears = continueDuring ? totalYears : Math.max(0, firstStart - 1);

        return {
            contribution: C_min,
            bindingYear,
            pvTotal,
            contributionYears,
            totalYears,
            fees,
            indicator
        };
    }

    /**
     * Compute total present value of fees (for display purposes)
     */
    function computeTotalPV(A, g, r, n, startYears) {
        const ratio = (1 + g) / (1 + r);

        let feeFactor;
        if (Math.abs(ratio - 1) < 1e-10) {
            feeFactor = n;
        } else {
            feeFactor = (1 - Math.pow(ratio, n)) / (1 - ratio);
        }

        return startYears.reduce((sum, startYear) => {
            const inflationDiscountFactor = Math.pow(ratio, startYear);
            return sum + A * inflationDiscountFactor * feeFactor;
        }, 0);
    }

    /**
     * Generate cash flows with correct timing:
     * At end of year t:
     *   1. Previous balance grows by (1+r)
     *   2. Add contribution if applicable
     *   3. Pay fees
     */
    function generateCashFlows(A, g, r, n, startYears, contribution, continueDuring) {
        const firstStart = Math.min(...startYears);
        const lastFeeYear = Math.max(...startYears) + n - 1;  // Last year of school
        const totalYears = lastFeeYear;

        const fees = buildFeeSchedule(A, g, n, startYears, totalYears);
        const indicator = buildContributionIndicator(continueDuring, firstStart, totalYears);

        const cashFlows = [];
        let balance = 0;

        for (let year = 1; year <= totalYears; year++) {
            const investmentReturn = balance * r;
            const yearContribution = indicator[year] * contribution;
            const feePayment = fees[year];

            balance = balance * (1 + r) + yearContribution - feePayment;

            cashFlows.push({
                year,
                contribution: yearContribution,
                feePayment,
                investmentReturn,
                endBalance: balance
            });
        }

        return cashFlows;
    }

    let chart = null;

    function parseNumber(str) {
        return parseFloat(str.replace(/[£,]/g, ''));
    }

    function formatCurrency(num) {
        return '£' + num.toLocaleString('en-GB', { 
            minimumFractionDigits: 0, 
            maximumFractionDigits: 0 
        });
    }

    function parseStartYears(str) {
        return str.split(',')
            .map(s => parseInt(s.trim()))
            .filter(n => !isNaN(n) && n >= 0);
    }

    function getInputs() {
        const A = parseNumber(document.getElementById('annualFee').value);
        const startYears = parseStartYears(document.getElementById('startYears').value);
        const n = parseInt(document.getElementById('schoolYears').value);
        const g = parseFloat(document.getElementById('inflation').value) / 100;
        const r = parseFloat(document.getElementById('returnRate').value) / 100;
        const continueDuring = document.getElementById('continueDuring').checked;

        if (isNaN(A) || startYears.length === 0 || isNaN(n) || isNaN(g) || isNaN(r)) {
            throw new Error('Please enter valid numbers');
        }

        const firstStart = Math.min(...startYears);
        const lastFeeYear = Math.max(...startYears) + n - 1;

        return { A, startYears, n, g, r, continueDuring, firstStart, lastFeeYear };
    }

    function calculate() {
        try {
            const { A, startYears, n, g, r, continueDuring, firstStart, lastFeeYear } = getInputs();

            const result = calculateLiquidityConstrained(A, g, r, n, startYears, continueDuring);
            const { contribution, bindingYear, pvTotal, contributionYears } = result;

            document.getElementById('results').style.display = 'block';
            document.getElementById('resultAmount').textContent = formatCurrency(contribution) + '/year';

            const childText = startYears.length === 1
                ? `1 child starting year ${startYears[0]}`
                : `${startYears.length} children starting years ${startYears.join(', ')}`;

            document.getElementById('resultDetails').innerHTML = `
                ${childText} · ${n} years of schooling ·
                Contributing for ${contributionYears} years<br>
                Total fees present value: ${formatCurrency(pvTotal)}<br>
                <strong>Binding constraint: Year ${bindingYear}</strong> (account reaches zero)
            `;

            updateChart(A, startYears, n, continueDuring, g, r);

            const cashFlows = generateCashFlows(A, g, r, n, startYears, contribution, continueDuring);
            updateCashFlowTable(cashFlows, bindingYear);

        } catch (e) {
            alert(e.message);
        }
    }

    function updateChart(A, startYears, n, continueDuring, inputInflation, inputReturn) {
        // Center the sensitivity analysis around user's input values
        const inflationOffsets = [-0.03, -0.02, -0.01, 0, 0.01, 0.02, 0.03];
        const returnOffsets = [-0.02, -0.01, 0, 0.01, 0.02];

        const inflationRates = inflationOffsets
            .map(offset => Math.max(0, inputInflation + offset));  // Don't go below 0%
        const returnRates = returnOffsets
            .map(offset => Math.max(0.01, inputReturn + offset));  // Don't go below 1%

        const colors = [
            'rgb(180, 100, 80)',
            'rgb(200, 140, 110)',
            'rgb(45, 90, 74)',      // Input value (center) in accent color
            'rgb(70, 130, 110)',
            'rgb(100, 160, 140)'
        ];

        const datasets = returnRates.map((retRate, idx) => {
            const contributions = inflationRates.map(infRate => {
                const result = calculateLiquidityConstrained(A, infRate, retRate, n, startYears, continueDuring);
                return result.contribution;
            });

            const isInputReturn = Math.abs(retRate - inputReturn) < 0.001;
            return {
                label: `${(retRate * 100).toFixed(0)}% return${isInputReturn ? ' (selected)' : ''}`,
                data: contributions,
                borderColor: colors[idx],
                backgroundColor: colors[idx],
                tension: 0.3,
                pointRadius: isInputReturn ? 6 : 4,
                borderWidth: isInputReturn ? 3 : 2
            };
        });

        const ctx = document.getElementById('sensitivityChart').getContext('2d');

        if (chart) {
            chart.destroy();
        }

        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: inflationRates.map(infRate => {
                    const isInput = Math.abs(infRate - inputInflation) < 0.001;
                    return isInput ? `${(infRate * 100).toFixed(0)}%*` : `${(infRate * 100).toFixed(0)}%`;
                }),
                datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Required Annual Contribution vs. Inflation Rate',
                        font: { size: 14, family: "'Crimson Pro', serif" }
                    },
                    legend: {
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Fee Inflation Rate'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Annual Contribution (£)'
                        },
                        ticks: {
                            callback: function(value) {
                                return formatCurrency(value);
                            }
                        }
                    }
                }
            }
        });
    }

    function updateCashFlowTable(cashFlows, bindingYear) {
        const tbody = document.getElementById('cashflowBody');
        tbody.innerHTML = cashFlows.map(cf => {
            const isBinding = cf.year === bindingYear;
            const rowClass = isBinding ? 'binding-row' : '';
            const contribClass = cf.contribution > 0 ? 'positive' : '';
            const contribText = cf.contribution > 0 ? '+' + formatCurrency(cf.contribution) : '—';

            return `
                <tr class="${rowClass}">
                    <td>${cf.year}${isBinding ? ' *' : ''}</td>
                    <td class="${contribClass}">${contribText}</td>
                    <td class="${cf.feePayment > 0 ? 'negative' : ''}">${cf.feePayment > 0 ? '-' + formatCurrency(cf.feePayment) : '—'}</td>
                    <td class="${cf.investmentReturn >= 0 ? 'positive' : 'negative'}">${cf.investmentReturn >= 0 ? '+' : ''}${formatCurrency(cf.investmentReturn)}</td>
                    <td>${formatCurrency(Math.round(cf.endBalance))}</td>
                </tr>
            `;
        }).join('');
    }

    function downloadCSV() {
        try {
            const { A, startYears, n, g, r, continueDuring } = getInputs();
            const result = calculateLiquidityConstrained(A, g, r, n, startYears, continueDuring);
            const { contribution, bindingYear, pvTotal } = result;

            const cashFlows = generateCashFlows(A, g, r, n, startYears, contribution, continueDuring);

            const headers = ['Year', 'Contribution', 'Fee Payment', 'Investment Return', 'End Balance', 'Binding Year'];
            const rows = cashFlows.map(cf => [
                cf.year,
                cf.contribution.toFixed(2),
                cf.feePayment.toFixed(2),
                cf.investmentReturn.toFixed(2),
                cf.endBalance.toFixed(2),
                cf.year === bindingYear ? 'Yes' : ''
            ]);

            const summary = [
                ['School Fund Planner - Cash Flow Schedule'],
                [''],
                ['Parameters:'],
                ['Annual Fee (today)', A],
                ['Children start years', startYears.join('; ')],
                ['Years of schooling', n],
                ['Fee inflation rate', (g * 100).toFixed(1) + '%'],
                ['Investment return rate', (r * 100).toFixed(1) + '%'],
                ['Continue during school', continueDuring ? 'Yes' : 'No'],
                [''],
                ['Results:'],
                ['Required annual contribution', contribution.toFixed(2)],
                ['Total fees present value', pvTotal.toFixed(2)],
                ['Binding constraint year', bindingYear],
                [''],
                headers,
                ...rows
            ];

            const csvContent = summary.map(row =>
                Array.isArray(row) ? row.join(',') : row
            ).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'school_fund_cashflows.csv';
            link.click();

        } catch (e) {
            alert(e.message);
        }
    }

    function toggleCollapsible(trigger) {
        trigger.classList.toggle('open');
        const content = trigger.nextElementSibling;
        content.classList.toggle('open');
    }

    document.addEventListener('DOMContentLoaded', function() {
        if (checkAccess()) {
            renderMathInElement(document.body, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '\\(', right: '\\)', display: false},
                    {left: '\\[', right: '\\]', display: true}
                ],
                throwOnError: false
            });

            calculate();
        }
    });

    window.addEventListener('hashchange', function() {
        if (checkAccess()) {
            location.reload();
        }
    });
</script>

</body>
</html>
